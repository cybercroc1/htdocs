<?php 
ini_set('session.use_cookies','1');
ini_set('session.use_trans_sid','0');
ini_set('max_execution_time','300');
include("../../sc_conf/sc_session");
session_start();

extract($_REQUEST);
if (!isset($xls_go)) {
echo '<html>
<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1251">
<link href="billing.css" rel="stylesheet" type="text/css">
</head>
<script language="javascript" src="superbilling.js"></script>
<body topmargin="0">';
}

if (!isset($_SESSION['i'])) exit(); 
if (!isset($_SESSION['admin']) or $_SESSION['admin']<>1) {echo "<font color=red>Страница недоступна!</font>"; exit();} 

include("../../sc_conf/sc_conn_string");
include("../../sc_conf/ab_conn_string");

//$aaa=OCIParse($c, "select replace(0.5/2,',','.') aaa from dual");
//OCIExecute($aaa,OCI_DEFAULT);
//OCIFetch($aaa);
//echo OCIResult($aaa,"AAA");

if(isset($selected_fields)) {
	$_SESSION['bill_selected_fields']=$selected_fields;
}

//Формирование дат

if(isset($start_bill_date)) $_SESSION['start_bill_date']=$start_bill_date;
if(isset($end_bill_date)) $_SESSION['end_bill_date']=$end_bill_date;

	if (!isset($_SESSION['start_bill_date'])) {
	$start_rep_date = strtotime("-1 day");
	$_SESSION['start_bill_date'] = date("d.m.Y",$start_rep_date);
	}
	
	if (!isset($_SESSION['end_bill_date'])) {
	$end_rep_date = strtotime("-1 day"); //текущая дата
	$_SESSION['end_bill_date'] = date("d.m.Y",$end_rep_date);
	}

$yesterday = strtotime("- 1 day");
$yesterday = date("d.m.Y",$yesterday);
$curdate = date("d.m.Y");
//
if(isset($xls_go)) report();

echo "<table width=100%>";
	echo "<form name=billing_frm method=post onsubmit=fSelectFields()>";
echo "<tr>";
echo "<td valign=top>";
	echo "<font size=3><b> Биллинг - \"".$_SESSION['project_name'][$_SESSION['i']]."\"</b> ";
echo "</td><td align=right rowspan=3>";

//ВЫБОР ПОЛЕЙ
echo "<table><tr>";
echo "<td>";
echo '<select size="8" style="width:240" name=all_fields multiple="multiple" onchange="if(this.options[selectedIndex].disabled)this.options[selectedIndex].selected=false">';

$q=OCIParse($abilling,"select field_name,full_name from ab_inc_fields order by ord");
OCIExecute($q,OCI_DEFAULT);
while(OCIFetch($q)) {
	echo "<option value='".OCIResult($q,"FIELD_NAME")."'>".OCIResult($q,"FULL_NAME")."</option>";
}
echo "</select>";
echo "</td>";
echo "<td>";

echo '<a href="javascript:fAddFields()"><img border="0" src="green_arrow_right.gif"></a><br><a href="javascript:fDelFields()"><img border="0" src="red_arrow_left.gif"></a>';
echo "</td>";
echo "<td rowspan=2>";
echo '<select size="8" style="width:240" id=selected_fields name=selected_fields[] multiple="multiple">';

if(isset($_SESSION['bill_selected_fields'])) {
	foreach($_SESSION['bill_selected_fields'] as $key => $val) {
		echo "<option value='$val'>$val</option>";
	}
}
else {
echo "<option value='START_DATE'></option>";
echo "<option value='START_TIME'></option>";
echo "<option value='DNIS'></option>";
echo "<option value='AON'></option>";
echo "<option value='CALL_TYPE'></option>";
echo "<option value='CALL_TYPE_PHONE'></option>";
echo "<option value='EXT'></option>";
echo "<option value='FORWARD_NUM'></option>";
echo "<option value='CODE'></option>";
echo "<option value='REGION'></option>";
echo "<option value='TARIF'></option>";
echo "<option value='DUR_SEC'></option>";
echo "<option value='DUR_MIN'></option>";
echo "<option value='IVR_SEC'></option>";
echo "<option value='IVR_MIN'></option>";
echo "<option value='CONNECTED_SEC'></option>";
echo "<option value='CONNECTED_MIN'></option>";
echo "<option value='STOIMOST'></option>";
}
echo "</select>";
echo "</td>";
echo "<td rowspan=2>";
echo '<a href="javascript:fUpFields()"><img border="0" src="blue_arrow_up.gif"></a>
<br>
<a href="javascript:fDownFields()"><img border="0" src="blue_arrow_down.gif"></a>';
echo "</td></tr></table>";
//

echo "</td></tr>";

echo "<tr>";
echo "<td valign=top>";		
		//список номеров
		$q=OCIParse($c,"select phone from sc_phones
		where project_id='".$_SESSION['project_id'][$_SESSION['i']]."'");
		OCIExecute($q,OCI_DEFAULT);
		$i=0;
		$opt="";
			while(OCIFetch($q)) {
			$opt.="<option value=".OCIResult($q,"PHONE").">".OCIResult($q,"PHONE")."</option>";
			$phone=OCIResult($q,"PHONE");
			$i++;
			}
		if ($i==0) {echo "<font color=red> Ошибка! Проекту не назначено ни одного номера доступа!"; exit();}
		if ($i==1) {
		echo "<input type=hidden name=cgpn value=".$phone.">";
		}
		if ($i>1) {
		echo "<select name=cgpn>";
		if ($cgpn<>'') echo "<option value=".$cgpn.">".$cgpn."</option>";
		echo "<option value=>Все номера</option>";
		echo $opt;
		echo "</select>";
		}
	//	
	//выбор даты
	
	echo "<table>";
	echo "<tr><td align=center>дата<br>";
	echo " c: <INPUT TYPE=TEXT NAME=start_bill_date value=".$_SESSION['start_bill_date']." SIZE=8 onClick='if(self.gfPop)gfPop.fPopCalendar(document.forms[0].start_bill_date);return false; HIDEFOCUS' onchange=fCheckDate()>"; 
	echo "</td>";
	echo "<td align=center ID=td_start_bill_hh>час.<br>";
	echo " <select name=start_bill_hh>";
	for($i=0; $i<=23; $i++) {
		echo "<option value=$i>$i</option>";
	}
	echo "</select>";
	echo "</td>";
	echo "<td align=center ID=td_start_bill_mi>мин.<br>";
	echo "<select name=start_bill_mi>";
	for($i=0; $i<=55; $i+=5) {
		echo "<option value=$i>$i</option>";
	}
	echo "</select>";
	echo "</td>";
	echo "<td align=center>дата<br>";
	echo " по: <INPUT TYPE=TEXT NAME=end_bill_date value=".$_SESSION['end_bill_date']." SIZE=8 onClick='if(self.gfPop)gfPop.fPopCalendar(document.forms[0].end_bill_date);return false; HIDEFOCUS' onchange=fCheckDate()>"; 
	echo "</td>";
	echo "<td align=center ID=td_end_bill_hh>час.<br>";
	echo " <select name=end_bill_hh>";
	for($i=0; $i<=23; $i++) {
		echo "<option value=$i>$i</option>";
	}
	echo "</select>";
	echo "</td>";
	echo "<td align=center ID=td_end_bill_mi>мин.<br>";
	echo "<select name=end_bill_mi>";
	for($i=0; $i<=55; $i+=5) {
		echo "<option value=$i>$i</option>";
	}
	echo "</select>";
	echo "</td>";
	echo "</tr>";
	echo "</table>";
	//
echo "</td>";
echo "</tr>";
echo "<tr>";
echo "<td valign=top>";

	echo "<INPUT type=submit name=report_go value=\"Показать отчет\"><INPUT type=submit name=xls_go value=\"XLS\">";
echo "</td>";
echo "</tr>";
echo "</table>";
	echo "<hr>";

echo '</form>';
flush();
?>
<iframe width=174 height=189 name="gToday:normal:agenda.js" id="gToday:normal:agenda.js" src="clndrxp94/ipopeng_superbill.htm" scrolling="no" frameborder="0" style="visibility:visible; z-index:999; position:absolute; top:-500px; left:-500px;">
</iframe>
<script>fBodyLoad();</script>
<?php
if (isset($report_go)) report();

//ОТЧЕТ
function report() {
	global $c;
	global $abilling;
	global $fields;
	global $query;
	extract($_REQUEST);
	//формируем список номеров $nums
	if ($cgpn=='') {
		$q=OCIParse($c,"select phone from sc_phones
		where project_id='".$_SESSION['project_id'][$_SESSION['i']]."'");
		OCIExecute($q,OCI_DEFAULT);
		$i=0;
		$nums='';
			while (OCIFetch($q)) {
				if ($i>0) $nums.=",";
				$nums.="'".OCIResult($q,"PHONE")."'";
				$i++;
			}
		if ($i>1) $nums=" in (".$nums.") "; else $nums="=".$nums; 	
	}
	else {
		$q=OCIParse($c,"select phone from sc_phones
		where project_id='".$_SESSION['project_id'][$_SESSION['i']]."' and phone='".$cgpn."'");
		OCIExecute($q,OCI_DEFAULT);
		OCIFetch($q);
		$nums="='".OCIResult($q,"PHONE")."'";
	}
	//

	//СТРОИМ ЗАПРОС
	//список полей
	$sql_text="select";
	$q=OCIParse($abilling,"select full_name,short_name,sql,html_width,xml_width,xml_type from ab_inc_fields where field_name=:field_name");

	$i=0;
	foreach($_SESSION['bill_selected_fields'] as $field_name) {
		OCIBindByName($q,":field_name",$field_name);
		OCIExecute($q,OCI_DEFAULT);
		if(OCIFetch($q)) {
			if($i==0) {$sql_text.=chr(10).chr(10); $sql_order_by="order by ";}
			else {$sql_text.=chr(10).','.chr(10); $sql_order_by.=",";}
			$sql_text.=OCIResult($q,"SQL");
			$sql_order_by.=$field_name;
			$i++;
			$fields[$i]['field_name']=$field_name;
			$fields[$i]['full_name']=OCIResult($q,"FULL_NAME");
			$fields[$i]['short_name']=OCIResult($q,"SHORT_NAME");
			$fields[$i]['html_width']=OCIResult($q,"HTML_WIDTH");
			$fields[$i]['xml_width']=OCIResult($q,"XML_WIDTH");
			$fields[$i]['xml_type']=OCIResult($q,"XML_TYPE");
		}	
	}
	//
	//FROM
	$sql_text.=chr(10).chr(10)."from cdr_calls a, ab_tarif_intersvyaz b".chr(10);
	//
	//WHERE
	//выбранный период
	$sql_text.=chr(10)." where 
       (
         a.offered_date BETWEEN to_date('".$_SESSION['start_bill_date']."','DD.MM.YYYY') AND to_date('".$_SESSION['end_bill_date']."','DD.MM.YYYY')+1 and connected_date is not null --Входящие 
      or a.originated_date BETWEEN to_date('".$_SESSION['start_bill_date']."','DD.MM.YYYY') AND to_date('".$_SESSION['end_bill_date']."','DD.MM.YYYY')+1 --Переводные
       )".chr(10);
	//
	//номера, но не раньше включения номера

	$sql_text.="and".chr(10);

	if ($cgpn=='') {
		$q=OCIParse($c,"select phone,to_char(date_set,'DD.MM.YYYY') date_set from sc_phones
		where project_id='".$_SESSION['project_id'][$_SESSION['i']]."'");
	}	
	else {
		$q=OCIParse($c,"select phone,to_char(date_set,'DD.MM.YYYY') date_set from sc_phones
		where project_id='".$_SESSION['project_id'][$_SESSION['i']]."' and phone='".$cgpn."'");
	}
	OCIExecute($q,OCI_DEFAULT);
	$i=0; $sql_or_vhod=''; $sql_or_forw='';
	while(OCIFetch($q)) {
		if($i==0) {$sql_or_vhod.=chr(10); $sql_or_forw.=chr(10);}
		else {$sql_or_vhod.=chr(10)."or "; $sql_or_forw.=chr(10)."or ";}
		$sql_or_vhod.="a.called_num = '".OCIResult($q,"PHONE")."' and a.offered_date >= to_date('".OCIResult($q,"DATE_SET")."','DD.MM.YYYY')";
		$sql_or_forw.="substr(uui,instr(a.uui,'DNIS=')+5,7) = '".OCIResult($q,"PHONE")."' and a.originated_date >= to_date('".OCIResult($q,"DATE_SET")."','DD.MM.YYYY')";
		$i++;
	}

	$sql_text.="(".chr(10)."( --входящие";
	$sql_text.=$sql_or_vhod.chr(10);
	$sql_text.=")".chr(10)."or".chr(10)."( --переводные";
	$sql_text.=$sql_or_forw.chr(10);
	$sql_text.=")".chr(10).")".chr(10); 
	//конец WHERE
	//завершаем построение запроса
	$sql_text.=chr(10)."and 
(a.call_end_date-a.connected_date)*24*60*60 > 5
and ab_code(a.called_num)=b.code(+)".chr(10);
	$sql_text.=$sql_order_by;

	$query=OCIParse($abilling,$sql_text);
	//ЗАПРОС ГОТОВ
	if(isset($report_go)) html();
	if(isset($xls_go)) xls();
	//
	//
	//
	//
}

function html() {
	global $fields;
	global $query;
	global $cgpn;	

	echo  "<table bgcolor=gray cellspacing=1 cellpadding=2><tr>";
	echo "<td bgcolor=white align=center><b>№</b></td>";
		foreach ($fields as $field) {
			echo "<td bgcolor=white align=center width='".$field['html_width']."'><b>".$field['short_name']."</b></td>";
		}
	echo "</tr>";
	flush();

	OCIExecute($query,OCI_DEFAULT);
	$i=0;
	while($row=oci_fetch_assoc($query)) {
		$i++;
		echo "<tr>";
		if(isset($row['CALL_TYPE']) and $row['CALL_TYPE']=='Переводной') $color='#DDDDDD'; else $color='white';
		echo "<td bgcolor='$color' align=center>$i</td>";
		foreach ($fields as $field) {
			if($row[$field['field_name']]=='0') $row[$field['field_name']]='';
			echo "<td bgcolor='$color' align=center width='".$field['html_width']."' title='".$field['full_name']."'>".$row[$field['field_name']]."</td>";
		}		
		echo "</tr>";
		flush();
	}
echo "</table>";
flush();
}

function xls() {
	global $fields;
	global $query;
	global $cgpn;

	header("Content-type: application/xls");
	header("Content-Disposition: attachment; filename=\"bil-".$_SESSION['start_bill_date']."-".$_SESSION['end_bill_date'].".xls\"");
	flush();
	//стили, начало книги
		echo '<?xml version="1.0" encoding="windows-1251"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:o="urn:schemas-microsoft-com:office:office"
 xmlns:x="urn:schemas-microsoft-com:office:excel"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:html="http://www.w3.org/TR/REC-html40">
 <ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel">
  <ProtectStructure>False</ProtectStructure>
  <ProtectWindows>False</ProtectWindows>
 </ExcelWorkbook>
 <Styles>
  <Style ss:ID="Default" ss:Name="Normal">
   <Alignment ss:Vertical="Bottom"/>
   <Borders/>
   <Font ss:FontName="Arial Cyr" x:CharSet="204"/>
   <Interior/>
   <NumberFormat/>
   <Protection/>
  </Style>
  <Style ss:ID="s21">
   <Font x:CharSet="204" x:Family="Swiss" ss:Size="9" ss:Color="#666699"/>
  </Style>
  <Style ss:ID="s35">
   <Alignment ss:Horizontal="Center" ss:Vertical="Bottom" ss:WrapText="1"/>
   <Borders>
    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>
   </Borders>
   <Font x:CharSet="204" x:Family="Swiss" ss:Size="9" ss:Color="#333333"/>
   <Interior ss:Color="#FFFFFF" ss:Pattern="Solid"/>
  </Style>
  <Style ss:ID="s36">
   <Alignment ss:Horizontal="Center" ss:Vertical="Bottom" ss:WrapText="1"/>
   <Borders>
    <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>
   </Borders>
   <Font x:CharSet="204" x:Family="Swiss" ss:Size="9" ss:Color="#333333"/>
   <Interior ss:Color="#DDDDDD" ss:Pattern="Solid"/>
  </Style>
  <Style ss:ID="s40">
   <Alignment ss:Horizontal="Center" ss:Vertical="Center" ss:WrapText="1"/>
   <Borders>
    <Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/>
    <Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/>
   </Borders>
   <Font x:CharSet="204" x:Family="Swiss" ss:Size="9" ss:Color="#333333"
    ss:Bold="1"/>
   <Interior ss:Color="#FFFFFF" ss:Pattern="Solid"/>
  </Style>
 </Styles>';
 	//
	flush();
	//Начало листа
		echo ' <Worksheet ss:Name="Биллинг">
  <AutoFilter x:Range="R2C2:R2C'.(count($fields)+1).'" xmlns="urn:schemas-microsoft-com:office:excel">
  </AutoFilter>  
  <Table x:FullColumns="1"
   x:FullRows="1">';
	echo '<Column ss:AutoFitWidth="0" ss:Width="30"/>'; 
	foreach ($fields as $field) {
		if($field['xml_width']=='') echo '<Column ss:AutoFitWidth="1"/>';
		else echo '<Column ss:AutoFitWidth="0" ss:Width="'.$field['xml_width'].'"/>'; 
	}
   	//
	flush();
	//первая строка
   	echo '<Row>
    <Cell ss:StyleID="s21"><ss:Data ss:Type="String"
      xmlns="http://www.w3.org/TR/REC-html40">';
	echo "Биллинг "; if ($cgpn<>'') {$num_txt="по номеру <B>".$cgpn."</B> "; echo $num_txt;} else {$num_txt="";}
	echo "за период с <B>".$_SESSION['start_bill_date']."</B> по <B>".$_SESSION['end_bill_date']."</B> включительно";
	echo '</ss:Data></Cell></Row>';
	//
	flush();
	//шапка
	echo  '<Row ss:AutoFitHeight="1">
    <Cell ss:StyleID="s40"><Data ss:Type="String">№</Data></Cell>';
    foreach ($fields as $field) {
		echo '<Cell ss:StyleID="s40"><Data ss:Type="String">'.$field['short_name'].'</Data></Cell>';
	}
	echo '</Row>';	
	//
	flush();
	//строки
	OCIExecute($query,OCI_DEFAULT);
	$i=0;
	while($row=oci_fetch_assoc($query)) {
		$i++;
		echo "<Row>";
		
		if(isset($row['CALL_TYPE']) and $row['CALL_TYPE']=='Переводной') $style='s36'; else $style='s35';
		
		echo '<Cell ss:StyleID="'.$style.'"><Data ss:Type="Number">'.$i.'</Data></Cell>';
		foreach ($fields as $field) {
			if($row[$field['field_name']]=='' or $row[$field['field_name']]=='0') {
				echo '<Cell ss:StyleID="'.$style.'"/>';
			}
			else {
				
				echo '<Cell ss:StyleID="'.$style.'"><Data ss:Type="'.$field['xml_type'].'">'.$row[$field['field_name']].'</Data></Cell>';	
			}	
		}
		echo "</Row>";
		flush();
	}
	//
	flush();
	
	//конец листа
	echo '</Table>
  <WorksheetOptions xmlns="urn:schemas-microsoft-com:office:excel">
   <PageSetup>
    <Header x:Margin="0.4"/>
    <PageMargins x:Bottom="0.58" x:Left="0.38" x:Right="0.41" x:Top="0.4"/>
   </PageSetup>
   <Print>
    <ValidPrinterInfo/>
    <PaperSizeIndex>9</PaperSizeIndex>
    <HorizontalResolution>600</HorizontalResolution>
    <VerticalResolution>0</VerticalResolution>
   </Print>
   <Selected/>
   <FreezePanes/>
   <FrozenNoSplit/>
   <SplitHorizontal>2</SplitHorizontal>
   <TopRowBottomPane>2</TopRowBottomPane>
   <ActivePane>2</ActivePane>
   <Panes>
    <Pane>
     <Number>3</Number>
    </Pane>
    <Pane>
     <Number>2</Number>
    </Pane>
   </Panes>
   <ProtectObjects>False</ProtectObjects>
   <ProtectScenarios>False</ProtectScenarios>
  </WorksheetOptions>
 </Worksheet>'; 
 //
 //конец книги
 echo "</Workbook>";
 flush();
exit();
}
?>
</body>
</html>

